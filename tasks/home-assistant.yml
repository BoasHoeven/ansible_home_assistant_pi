---
- name: Create home-assistant folder on Pi.
  ansible.builtin.file:
    path: "{{ config_dir }}/home-assistant"
    state: directory
    mode: 0755
  become: false

- name: Create home-assistant/config folder on Pi.
  ansible.builtin.file:
    path: "{{ config_dir }}/home-assistant/config"
    state: directory
    mode: 0755
  become: false

- name: Copy home-assistant docker-compose template to Pi.
  ansible.builtin.template:
    src: templates/home-assistant-docker-compose.yml.j2
    dest: "{{ config_dir }}/home-assistant/docker-compose.yml"
    mode: 0640
  become: false

- name: Ensure home-assistant is running.
  community.docker.docker_compose:
    project_src: "{{ config_dir }}/home-assistant/"
    build: false
  become: false

- name: Check if sidebar is present in Home Assistant configuration
  ansible.builtin.lineinfile:
    path: /{{ config_dir }}/home-assistant/config/configuration.yaml
    line: "panel_iframe:"
    state: present
  register: sidebar_found
  check_mode: true
  
- name: Create a backup of Home Assistant configuration
  ansible.builtin.copy:
    src: /{{ config_dir }}/home-assistant/config/configuration.yaml
    dest: /tmp/file.tmp
    mode: 0644
  when: sidebar_found.changed == false

- name: Add sidebar configuration to Home Assistant configuration
  ansible.builtin.blockinfile:
    path: /tmp/file.tmp
    block: |
      panel_iframe:
        zigbee2mqtt:
          title: "zigbee2mqtt"
          url: "http://172.80.0.35:8080"
          icon: mdi:zigbee
          require_admin: true
    backup: yes
    marker: "# {mark} ANSIBLE MANAGED BLOCK"
  when: sidebar_found.changed == false

- name: Update Home Assistant configuration file with sidebar
  ansible.builtin.copy:
    src: /tmp/file.tmp
    dest: /{{ config_dir }}/home-assistant/config/configuration.yaml
    mode: 0644
  when: sidebar_found.changed == false
